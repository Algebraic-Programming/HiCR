name: Build and Run Tests

on:
  workflow_run:
    workflows: [Build and Push Docker Images]
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:

  # Build HiCR and run tests
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'skipped' }}
    container:
      image: ghcr.io/algebraic-programming/hicr/buildenv:latest
      options: --user hicr
      credentials:
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
      
    steps:
    - name: Add PR Checks
      uses: patriknyblad/add-pr-checks@v1.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        checks: |
         {
            "name": "Build and Run Tests",
            "head_sha": ${{ github.sha }},
            "status": "in_progress",
            "output": {
                "title": "Build and Run Tests",
                "summary": "Build and Run Tests",
                "text": "Build and Run Tests"
            }
          }
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup 
      run:  meson setup build -Dbackends=hwloc,pthreads,mpi,lpf,nosv,boost,opencl -Dfrontends=channel,RPCEngine,tasking,objectStore -DbuildTests=true -DbuildExamples=true -DcompileWarningsAsErrors=true
           
    - name: Compile
      run:  meson compile -C build

    - name: Running tests and creating coverage report
      id: tests
      shell: bash
      run:  |
            echo "Running Tests..."
            meson setup build --wipe -Db_coverage=true -Dbackends=hwloc,pthreads,mpi,nosv,boost -Dfrontends=channel,RPCEngine,tasking,objectStore -DbuildTests=true -DbuildExamples=true -DcompileWarningsAsErrors=true
            meson compile -C build
            meson test -C build
            echo "Creating coverage report..."
            ninja -C build coverage
    - name: Code Coverage Report
      uses: irongut/CodeCoverageSummary@v1.3.0
      with:
        filename: build/meson-logs/coverage.xml
        badge: true
        fail_below_min: true
        format: markdown
        hide_branch_rate: false
        hide_complexity: true
        indicators: true
        output: both
        thresholds: '60 80'
    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        recreate: true
        path: code-coverage-results.md
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: meson-logs
        path: build/meson-logs/
    
    - name: Add PR Checks
      uses: patriknyblad/add-pr-checks@v1.1.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        checks: |
         {
            "name": "Build and Run Tests",
            "head_sha": ${{ github.sha }},
            "status": "completed",
            "conclusion": ${{ steps.tests.conclusion }},
            "output": {
                "title": "Build and Run Tests",
                "summary": "Build and Run Tests",
                "text": "Build and Run Tests"
            }
          }